<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script>
    (function(){
        if(''){
            if (prompt('‰∏çÂ•ΩÊÑèÊÄùÔºåËøôÁØáÊñáÁ´†ÈúÄË¶ÅÂØÜÁ†ÅÔºÅ') !== ''){
                alert('ÂØÜÁ†ÅÈîôËØØÔºÅ');
                history.back();
            }
        }
    })();
</script>


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="1075199251,Âº†ÂáØ,18772383543,wuwii,ËøΩÂÖâËÄÖw,ÊúâÊ¢¶ÊÉ≥ÁöÑÂí∏È±º,‰∏ÄÊ£µÊ†ëÁ´ôÂú®ÂéüÈáé‰∏ä,Slience" />





  <link rel="alternate" href="/atom.xml" title="ÂñÉÂ£∞ÁªÜËØ≠" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.1" />






<meta name="description" content="This document is to document the learning process for System Design.A few concepts to research:How to split data between servers? How do multiple server communicate? MapReduce?How does server process">
<meta name="keywords" content="1075199251,Âº†ÂáØ,18772383543,wuwii,ËøΩÂÖâËÄÖw,ÊúâÊ¢¶ÊÉ≥ÁöÑÂí∏È±º,‰∏ÄÊ£µÊ†ëÁ´ôÂú®ÂéüÈáé‰∏ä,Slience">
<meta property="og:type" content="article">
<meta property="og:title" content="System Design">
<meta property="og:url" content="http://blog.wuwii.com/system-design.html">
<meta property="og:site_name" content="ÂñÉÂ£∞ÁªÜËØ≠">
<meta property="og:description" content="This document is to document the learning process for System Design.A few concepts to research:How to split data between servers? How do multiple server communicate? MapReduce?How does server process">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-12-22T01:11:21.008Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="System Design">
<meta name="twitter:description" content="This document is to document the learning process for System Design.A few concepts to research:How to split data between servers? How do multiple server communicate? MapReduce?How does server process">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Âçö‰∏ª'
    },
    algolia: {
      applicationID: 'TWXZ15WRBL',
      apiKey: 'c272bd4b810c8b43773a3f1d3c6b8d27',
      indexName: 'wuwii',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.wuwii.com/system-design.html"/>





  <title>System Design | ÂñÉÂ£∞ÁªÜËØ≠</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b847762b9271725a63131e554978de0a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=63798915";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1264593822&web_id=1264593822" language="JavaScript"></script>
  </div>





  
  <link href="http://blog.wuwii.com/harlem-shake-style.css" rel="stylesheet" type="text/css" />
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ÂñÉÂ£∞ÁªÜËØ≠</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">‰∏Ä‰∏™‰∫∫ÁöÑÁã¨ÁôΩÔºåÊàê‰∏∫ÊúÄÂ•ΩÁöÑËá™Â∑±ÔºåÈÅáÂà∞ÊúÄÂ•ΩÁöÑÈÇ£‰∏™‰∫∫„ÄÇ</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            È¶ñÈ°µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            ÂàÜÁ±ª
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            ÂÖ≥‰∫é
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            ÂΩíÊ°£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Ê†áÁ≠æ
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            ÊêúÁ¥¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="ÊêúÁ¥¢..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.wuwii.com/system-design.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Slience">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://image.wuwii.com/MTXX_20170504095121_mr1493862851443.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ÂñÉÂ£∞ÁªÜËØ≠">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">System Design</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">ÂèëË°®‰∫é</span>
              
              <time title="ÂàõÂª∫‰∫é" itemprop="dateCreated datePublished" datetime="2017-12-22T10:08:03+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">ÂàÜÁ±ª‰∫é</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Â≠¶‰π†Á¨îËÆ∞/" itemprop="url" rel="index">
                    <span itemprop="name">Â≠¶‰π†Á¨îËÆ∞</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Â≠óÊï∞ÁªüËÆ°</span>
                
                <span title="Â≠óÊï∞ÁªüËÆ°">
                  2,360
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">ÈòÖËØªÊó∂Èïø</span>
                
                <span title="ÈòÖËØªÊó∂Èïø">
                  15
                </span>
              
            </div>
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>This document is to document the learning process for <strong>System Design</strong>.<br>A few concepts to research:<br>How to split data between servers? How do multiple server communicate? MapReduce?<br>How does server process heavy calculation in background? Threading? NodeJS threading?</p>
<a id="more"></a>
<h2 id="Good-Concepts"><a href="#Good-Concepts" class="headerlink" title="Good Concepts:"></a>Good Concepts:</h2><ul>
<li>For any system, consider: how much data does the system handle? how much data does the system need to store?</li>
<li>Popular hashing algorithm: like 35.      What about md5?</li>
<li>Scalibility</li>
</ul>
<h2 id="Steps"><a href="#Steps" class="headerlink" title="Steps:"></a>Steps:</h2><ol>
<li><strong>Scope</strong> the problem: Don‚Äôt make assumptions; Ask questions; Understand the constraints and use cases.</li>
<li>Sketch up an <strong>abstract design</strong> that illustrates the basic components of the system and the relationships between them.</li>
<li>Think about the <strong>bottlenecks</strong> these components face when the system scales.</li>
<li>Address these bottlenecks by using the fundamentals principles of <strong>scalable</strong> system design.</li>
</ol>
<ul>
<li>Mine Usual steps: might be too much details on scoping but less efforts onto bottlenecks and scalibility issues.</li>
</ul>
<ol>
<li>Identify the key requirements &amp;&amp; constraints</li>
<li>Identify the users &amp;&amp; Server</li>
<li>Identify inputs/ouputs from different users<br><em>*</em> Calculate the bandwidth and storage: the amount of data the server handles, and the amount of data server stores.</li>
<li>Based on (1~3), list out the potential features that needs to be implemented</li>
<li>Pick technologies that will be able to implement the features above: <ul>
<li>backend server</li>
<li>user client</li>
<li>method of storage</li>
<li>method of data trasmissio</li>
</ul>
</li>
<li>How does the system scale? What are the limits and trade-off in current design? What improvmenet can be done to design it differently?</li>
</ol>
<h2 id="Scalibility-lecture"><a href="#Scalibility-lecture" class="headerlink" title="Scalibility lecture"></a>Scalibility lecture</h2><ul>
<li><p>key concepts:<br>  Vertical scaling: add more cpu,ram,hard-drive<br>  Horizontal scaling:add more cheaper computer, distribute traffice &amp;&amp; storage into these machiens.<br>  Caching: save some pre-processed data, like sticky session, pre-quried sqls<br>  Load balancing: determine which web server to hit; determine which db to hit if having multiple db<br>  Database replication: for faster read; for reduancy safety<br>  Database partitioning: for faster performance for some contents, or distributed storage<br>  Using NoSQL instead of scaling a relational database<br>  Being asynchronous   </p>
</li>
<li><p>Load Balancer?<br>  load balancer is even good to protect server: now backend server can be on LAN with load balancer, so they are protected; and we just expose load balancer to clients.<br>  How does load balancer work?<br>  There are lots of trade-offs: look at 30:00 of the video. That‚Äôs all the tradeoffs (<a href="http://www.hiredintech.com/system-design/scalability-fundamentals/" target="_blank" rel="external">http://www.hiredintech.com/system-design/scalability-fundamentals/</a>)</p>
<pre><code>- round robin: the load balancer works as a fancy DNS machine, take turns to assign task/request to machine 1,2,3,4...etc. (if we do `nsloopup google.com` on google.com, we can see google does that)
- store states/sessions into a dedicated server. but it indroduces server-failure issue. -use RAID, raplication
    RAID0: strip data at two hardrives, little on each
    RAID1: mirror data. store at both places
    RAID10: combination of RAID0 &amp;&amp; RAID1.
    RAID5: 3 drives only 1 of them is used for reduendency.
    RAID6: multiple drives. any drive can die, then replace, and no data lost.
- split by the type of files request: html server, image server; load balancer
- split based on actual load (less possible), send package to less busy server
</code></pre><p>  Options:<br>  Software:</p>
<pre><code>ELB: elastic load balancer
HAProxy
LVS 
</code></pre><p>  hardware:</p>
<pre><code>Barracuda
Cisco
Citrix: over-priced, $20k 
F5
</code></pre><p>  Problem: sticky session (if you revisit the site multiple times seprately, you will still hit the same server)</p>
<pre><code>- can store serverID in the cookie (one downside: safety, showed the whole world about server IP). So again, can store a random number/hashed value on Load Balancer. It shows which serverID to hit once revisiting. Remember which back-end server to send cookie to.
</code></pre></li>
<li><p>Caching:<br>  file-based caching approach: send .html out.</p>
<pre><code>down-side: 1. space. 2. old generated files are really hard to change.
</code></pre><p>  mysqul-query cashed: for identical sql request<br>  memcached: store in memory of the idetical query. Like a table. store <key, value="">.</key,></p>
<pre><code>next time when checking, try look up key.
Down-side: run out of ram. Solution: LRUCahe, remove old records(double-linked-list)
</code></pre></li>
<li><p>Replication:<br>  Master &amp;&amp; multiple Slaves</p>
<pre><code>advantage: 1. Same request/query will be paste to all slaves, so master fail, just put up one salve; 2. If READ heavy, they are redundant server to lots readings.
disadvantage:
</code></pre><p>  Must have at least load balancer: that is one-point-failure if just one load balancer</p>
</li>
<li><p>Partitioning:<br>  based on user informaiton, like name. Put common user (same last name) into certain servers.</p>
</li>
<li><p>Bottleneck: data traffice and data storage</p>
</li>
<li>‚Äî‚ÄîExample</li>
<li>1:26:00 of the video (<a href="http://www.hiredintech.com/system-design/scalability-fundamentals/" target="_blank" rel="external">http://www.hiredintech.com/system-design/scalability-fundamentals/</a>)<br>We have backend web server<br>Sticky session: use cookie and store server ID<br>Use load balancer that two web server connects:<br>Use load balancer to link to the two master db:<br>  Two master db that talks to each other: master-master replication<br>Now we need 2 load balancer to prevent one-point-failure at the webServer-db connection.<br>Now we also need 2 load balancers at the (which web server to hit) level, that is another 1-pointer-failure<br>Switch for the complex connections:<br>  Now we have so many connections: we need switches to handle the connections.<br>  We need at least two ports on each device to: go to the correct switch. Becareful with loop.</li>
<li><p>Eventually we will handle: (1:34:00)<br>  Scalibility<br>  Redundancy<br>  High probablity of up time<br>  Resolution against failure</p>
</li>
<li><p>Another big issue:<br>  What is ISP goes down? The whole package mentioned above go down?</p>
<pre><code>Amazon solution, another ISP, called avalibility zone: like west, asia, south american.
How to distribute IP on different data center? Load Balancer at the DNS level, global Load Balancer.  (Note, if in one building, could be staying at this building)
    Well, if a building is gone, once your TTL(Time to live) is expired, you will be re-route to another ISP building.
</code></pre></li>
<li><p>Before getting into building:<br>  Firewall, only a few ports are open: like tcp80, 443, 22 (ssh)<br>  can allow https before first load balancer inside building, and decrypt it after first load balancer<br>  at db lever, only 3306 is allowed.<br>Reason to lock, for example, 3306 not allowed at entering building? Because no one needs to inject query to db from outside of building; sql query usually only need to be done within the building, so lock the building up, don‚Äôt allow bad sql injection : )</p>
</li>
</ul>
<h3 id="URL-convention-Example-Final-http-www-hiredintech-com-system-design-final-thoughts"><a href="#URL-convention-Example-Final-http-www-hiredintech-com-system-design-final-thoughts" class="headerlink" title="URL convention Example Final (http://www.hiredintech.com/system-design/final-thoughts/)"></a>URL convention Example Final (<a href="http://www.hiredintech.com/system-design/final-thoughts/" target="_blank" rel="external">http://www.hiredintech.com/system-design/final-thoughts/</a>)</h3><ul>
<li><p>simple rules:<br>  Always start a single machine<br>  Benchmark the bottle necks, where it indroduces complexity. (No need to add extra complexity)<br>  Think about the questions like: why sql vs. non-sql?</p>
</li>
<li><p>Scalable design:</p>
<ol>
<li><p>Application, web server, handle requests/traffic</p>
<ul>
<li>start with 1 server</li>
<li>it‚Äôs better to measure the spark traffic (highest we get)</li>
<li>add load balancer, and a cluster of servers. (could use amazon elastic load balancer, to automatically add more servers)</li>
</ul>
</li>
<li><p>Data Storage<br> 1) Billions of object,  2) each object is small, 3) no relationship between object, 4) read 9x more than write (360read/s, 40writes/s), 5) 3TB urls, 36GB of hashes<br> We can use sql or non-sql<br> In example, go with MySQL</p>
<pre><code>widely used
Mature tech
Clear scaling paradiams(sharding, master/slave replication, master/master replication)
Used by fb, twitter, google.
* index lookups are very fast (as fast as non-sql)
</code></pre><p> mappings:</p>
<pre><code>hash: varchar(6)
original_url: varchar(512)
</code></pre><p> Over years, it holds 3TB data. Storage-wise, it‚Äôs okay. However, how to serve up quickly?</p>
<ul>
<li>First, Use one MySQL table with two varchar fields</li>
<li>Create uinique index on the hash(36GB+). We want to hold it in memory. However, we need to look up fast.</li>
<li>For 1st stemp, vertical scaling of the MySQL machine, adding more RAM (nowadays ram are cheaper too : )</li>
<li>Eventually need to partition the data, into 5 partitions: 600GB of data, 8GB of indexes on each machine. (Partitioning early on, it helps to scale later, just add more nodes)</li>
<li>One day, if read/write are super different, Master-Slave, ‚Ä¶<br>  write to master, and read from slaves.</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="Design-UBER"><a href="#Design-UBER" class="headerlink" title="Design UBER"></a>Design UBER</h2><ol>
<li><p>Requirements<br>Same requirements between user &amp;&amp; driver: GPS tracking, detect pickup/drop off, cost calculation<br>Design a web app (or mobile app) for end user to make/cancel car reservation, make payment, rate driver.<br>Design a web app (or mobile app) for driver to accept/decline car reservation, accept payment, rate passenger.<br>Extra features beyond basics: car pool, split cost, rush-hour rate calculation.</p>
</li>
<li><p>Identify the end systems:<br>Backend server that handles communication, data tracking, payment trasaction‚Ä¶etc<br>Passenger user app<br>Driver user app</p>
</li>
<li><p>Inputs and outputs of each end system:<br><strong>Server should store every piece of information received or change to database during this process</strong><br>Server-input:</p>
<ul>
<li>Passenger create account, login, log off</li>
<li>Driver create account, login, log off</li>
<li>Passenger/Driver payment information</li>
<li>driver locations</li>
<li>passenger locations</li>
<li>GPS location data before &amp;&amp; during the trip</li>
<li>request to pair driver &amp;&amp; passenger</li>
<li>request to start trip</li>
<li>request to end trip</li>
<li>request to drop reservation from driver</li>
<li>request to drop reservation from passenger</li>
<li>request to calculate cost per trip</li>
<li>accept rating, comment, report ‚Ä¶ </li>
</ul>
<p>Server-output: </p>
<pre><code>* ack passenger account generation, login, logoff
* ack driver account generation, login, logoff
* ack driver/passenger payment info and store to db
</code></pre><ul>
<li>broadcast driver locations to passenger</li>
<li>broadcast passenger locations to driver</li>
<li>response pair confirmation to driver &amp;&amp; passenger with contact information of driver&amp;&amp;passenger</li>
<li>start a trip between driver &amp;&amp; passenger</li>
<li>end a trip between driver &amp;&amp; passenger</li>
<li>calculate recommended route and send to driver&amp;&amp;passenger</li>
<li>response reservation dropped from driver with panelty</li>
<li>response reservation dropped from passenger with panelty</li>
<li>response cost calculated to passenger and intiate payment charge to passenger</li>
<li>response cost calculated to driver and initiate payment to driver</li>
<li>store rating, comment, report into database. Trigger messages to coresponding party.</li>
</ul>
<p>Passenger-input: data that passenger receives</p>
<ul>
<li>ack of login and ready to pick driver</li>
<li>status of drivers around current location</li>
<li>auto-matched driver and related information about driver, car condition, price rate</li>
<li>confirmation of car reservation with driver‚Äôs info</li>
<li>trip route and estimated time</li>
<li>GPS tracking of car arriving or GPS tracking during the trip</li>
<li>notification of payment</li>
<li>notification of canceled trip</li>
<li>prompt to rate and comment</li>
<li>phone call from driver (extenal)</li>
</ul>
<p>Passenger-output: action that passenger takes</p>
<ul>
<li>create account</li>
<li>login</li>
<li>add payment information</li>
<li>put current location and destination location</li>
<li>select type of uber car, and start searching(matching)</li>
<li>accept/decline auto-matched driver</li>
<li>call driver (extenal)</li>
<li>cancel reservation</li>
<li>put comment, rating, or report to the system</li>
<li>automatically pay (be charged) of the trip cost from server</li>
</ul>
<p>Driver-input:</p>
<ul>
<li>ack of login and ready to start driving</li>
<li>auto-recommended passenger‚Äôs information: location, passenger rating</li>
<li>confirmation of reservation &amp;&amp; current waiting location</li>
<li>trip route and estimated time</li>
<li>GPS tracking of car arriving or GPS tracking during the trip</li>
<li>notification of payment</li>
<li>notification of trip cancelation from passenger</li>
<li>prompt to rate and comment passenger</li>
<li>phone call from passenger (extenal)</li>
<li>receive payment from server</li>
</ul>
<p>Driver-output:</p>
<ul>
<li>create account</li>
<li>login and set status avaialbe</li>
<li>add payment info</li>
<li>accept/decline recommended match</li>
<li>call passenger (extenal)</li>
<li>cancel reservation</li>
<li>put comment &amp;&amp; rating of passenger</li>
</ul>
</li>
</ol>
<ol>
<li><p>Summarize core features and tools to implement</p>
<ul>
<li>account management: </li>
<li>payment integration: paypal integration? some other credicar processing tools</li>
<li>matching algorithm: core problem to solve. Figure out the cheapest match for passenger, and time&amp;&amp;cost efficient match for driver. There might be lots of constraints to think about for the matching algorithm: cost&amp;&amp;time to pick up passenger around multiple driver, based on driver preference to filter type of trip (farest distance to travel)</li>
<li>trip process monitoring, notification: RESTful calls between server &amp;&amp; driver &amp;&amp; passenger. </li>
<li>GPS location tracking and route calculation: Google map?</li>
<li>trip cost calculation: calculated based on route length, trip time, rate at specific time, complains filed by passenger</li>
<li>rating &amp;&amp; comment system: RESTful post from driver/passenger</li>
</ul>
</li>
<li><p>Technologies potentially needed:<br>Tools:A server to handle RESTful calls, support live connection between nodes, handle trip matching algorithm, handle cost calculation.</p>
<ul>
<li>Node.js with expressJS: provide RESTful API </li>
<li>Socket.io for concurrent communication between server, user, driver in the same socket room.</li>
<li>Data storag: Sql or non-sql? Why? Later on, it seems easy to split data by region, so non-sql db seems okay to use.</li>
<li>Algorithm: How does heavy calculation handled on Nodejs? Should it be something to do with multi-threading?</li>
</ul>
</li>
<li><p>How does the system scale? What are the limits and trade-off in current design? What improvmenet can be done to design it differently?<br>First, assume everything is running based off one giant server: all conversations and calculation are handled via this server.<br>Second, the size of data might be too costly to search, calculate, and it‚Äôs not practical to store everything on one machine:</p>
<ul>
<li>user/driver account info might be too large</li>
<li>concurrent calculation for trip matching</li>
<li>number concurrent trip monitoring and conversation</li>
<li>concurrent calculation for trip cost<br>Therefore, it seems wiser to split onto multiple servers.<br>Third question: in which way to split the data? It seems we need to treat different type of data separately</li>
<li>For actively moving driver and user: we can store their location data dynamically by region. Once moved into/out of one regin, poll the information from one server into another server. Here, it‚Äôs wise to use HashTable to store as <userid, everything="" about="" this="" user="">. Calculation algorithm may also happen on this server, because both driver &amp;&amp; passenger are on this server, defined by region. </userid,></li>
<li>Now we‚Äôve splitted data into servers by region. However, for same region, it might be too much work for one machine. We need to split data aross different machines for same region. Here, use another Hash lookup table to store <live tripid,="" server="" id=""> to split data into even smaller sections to fit in different server. Now we can have more <strong>regionServer</strong>.</live></li>
<li>A improvement that can be done: for relative static information account,payment,rating, they are only used once or twice during a trip. It might be okay to store these information on a type of server that specifically handles account look up, let‚Äôs call it <strong>accountServer</strong>. Again, there might be too much account info to store, we can build lookup tables to store <accountid, serverid="">. Double again, do MapReduce to hash the keys so that we can split the look up table if the table is too big to store on one server.</accountid,></li>
</ul>
</li>
</ol>

      
    </div>
	<!--20170827Ê∑ªÂä†ÂÖ®ÊñáÁªìÊùü-->
	<div>
		
		<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">------Êú¨ÊñáÁªìÊùü üñê ÊÑüË∞¢ÈòÖËØª------</div>
    
</div>

		
	</div>
    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/system/" rel="tag"><i class="fa fa-tag"></i> system</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/linux-vim.html" rel="next" title="VimÂëΩ‰ª§ÂêàÈõÜ">
                <i class="fa fa-chevron-left"></i> VimÂëΩ‰ª§ÂêàÈõÜ
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "1",
        "bdMiniList": false,
        "bdPic": ""
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "ÂàÜ‰∫´Âà∞Ôºö",
        "viewSize": "16"
      },
      "slide": {
        "bdImg": "5",
        "bdPos": "left",
        "bdTop": "100"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            ÊñáÁ´†ÁõÆÂΩï
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Á´ôÁÇπÊ¶ÇËßà
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://image.wuwii.com/MTXX_20170504095121_mr1493862851443.jpg"
               alt="Slience" />
          <p class="site-author-name" itemprop="name">Slience</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">128</span>
                <span class="site-state-item-name">Êó•Âøó</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">ÂàÜÁ±ª</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">58</span>
                <span class="site-state-item-name">Ê†áÁ≠æ</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
			
			<a title="Êî∂ËóèÂà∞‰π¶Á≠æÔºåÂÅ∂Â∞îHigh‰∏Ä‰∏ã^_^" rel="alternate" class="mw-harlem_shake_slow wobble shake" href='javascript:(
    /*
     * Copyright (C) 2015 Rocko (rocko.xyz) <rocko.zxp@gmail.com>
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *      http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
    function go() {
    
      var songs = [
          "http://ov62kaxkk.bkt.clouddn.com/%E6%9C%A8%E6%9D%91%E5%BC%93%20-%20%E3%81%84%E3%81%A4%E3%82%82%E4%BD%95%E5%BA%A6%E3%81%A7%E3%82%82.mp3",       
          "......"
      ];
 
      function S() {
          var e = document.getElementById("audio_element_id");
          if(e != null){
              var index = parseInt(e.getAttribute("curSongIndex"));
              if(index > songs.length - 2) {
                  index = 0;
              } else {
                  index++;
              }
              e.setAttribute("curSongIndex", index);
          }
          e.src = i;
          e.play()
      }
      function initAudioEle() {
          var e = document.getElementById("audio_element_id");
          if(e === null){
            e = document.createElement("audio");
            e.setAttribute("curSongIndex", 0);
            e.id = "audio_element_id";
            e.loop = false;
            e.bgcolor = 0;
            e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
            document.body.appendChild(e);
            e.addEventListener("ended", function() {
              go();
            }, true);
          }        
      }
    
      initAudioEle();
      var curSongIndex = parseInt(document.getElementById("audio_element_id").getAttribute("curSongIndex"));
      var i = songs[curSongIndex];
      S();
    })()'>
    <i class="fa fa-music"></i> Âê¨Èü≥‰πê</a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kaimz" target="_blank" title="GitHub" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/p/1005053974218109" target="_blank" title="Weibo" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/zhang-kai-89-51-58" target="_blank" title="Áü•‰πé" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Áü•‰πé
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.processon.com/" title="processon" target="_blank" rel="external nofollow">processon</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://asciiflow.com/" title="asciiflow" target="_blank" rel="external nofollow">asciiflow</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://codepen.io/pen" title="codepen.io" target="_blank" rel="external nofollow">codepen.io</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://sdll.club" title="Èó™ÁîµÊãâÊãâ" target="_blank" rel="external nofollow">Èó™ÁîµÊãâÊãâ</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://leetcode.com/" title="leetcode" target="_blank" rel="external nofollow">leetcode</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.lintcode.com/" title="lintcode" target="_blank" rel="external nofollow">lintcode</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://stackoverflow.com/" title="stackoverflow" target="_blank" rel="external nofollow">stackoverflow</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.importnew.com/" title="ImportNew" target="_blank" rel="external nofollow">ImportNew</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://ifeve.com/" title="ifeve" target="_blank" rel="external nofollow">ifeve</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.720ui.com/" title="Ê¢ÅÊ°ÇÈíäÁöÑÂçöÂÆ¢" target="_blank" rel="external nofollow">Ê¢ÅÊ°ÇÈíäÁöÑÂçöÂÆ¢</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://edu.aliyun.com/" title="ÈòøÈáå‰∫ëÂ§ßÂ≠¶" target="_blank" rel="external nofollow">ÈòøÈáå‰∫ëÂ§ßÂ≠¶</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.iocoder.cn/" title="„ÄåËäãÈÅìÊ∫êÁ†Å„Äç" target="_blank" rel="external nofollow">„ÄåËäãÈÅìÊ∫êÁ†Å„Äç</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://cmsblogs.com" title="cmsblogs" target="_blank" rel="external nofollow">cmsblogs</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://36kr.com/" title="36Ê∞™" target="_blank" rel="external nofollow">36Ê∞™</a>
                </li>
              
            </ul>
          </div>
        
		<!--20170726Ê∑ªÂä†ÁΩëÊòì‰∫ëÈü≥‰πêÊ†áÁ≠æ -->
		<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=320 height=86 src="//music.163.com/outchain/player?type=2&id=356034&auto=0&height=66"></iframe> -->
        <!--20170726Ê∑ªÂä†ÁΩëÊòì‰∫ëÈü≥‰πêÊ†áÁ≠æ end-->
		


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Good-Concepts"><span class="nav-number">1.</span> <span class="nav-text">Good Concepts:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Steps"><span class="nav-number">2.</span> <span class="nav-text">Steps:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scalibility-lecture"><span class="nav-number">3.</span> <span class="nav-text">Scalibility lecture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#URL-convention-Example-Final-http-www-hiredintech-com-system-design-final-thoughts"><span class="nav-number">3.1.</span> <span class="nav-text">URL convention Example Final (http://www.hiredintech.com/system-design/final-thoughts/)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Design-UBER"><span class="nav-number">4.</span> <span class="nav-text">Design UBER</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Slience</span>
</div>



<div class="powered-by">
Hosted by <a href="https://pages.coding.me" rel="external nofollow">Coding Pages</a></div>

<div class="theme-info">
  <span class="post-count">ÂçöÂÆ¢ÂÖ®Á´ôÂÖ±157.8kÂ≠ó</span>
</div>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
	
	var src360 = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f62559b2127396ecb27f4ed4f4652ea1":"https://jspassport.ssl.qhimg.com/11.0.1.js?f62559b2127396ecb27f4ed4f4652ea1";
	document.write('<script src="' + src360 + '" id="sozz"><\/script>');
})();
</script>
        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

  <script type="text/javascript" src="/js/src/love.js"></script>
</body>
</html>
